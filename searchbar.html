<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17524250047"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-17524250047');
</script>
  <!-- Authentication Check -->
  <script type="module" src="auth-check.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>EduTube - Curated Learning</title>
  <style>
    :root{
      --panel:rgba(255,255,255,0.1);
      --muted:rgba(255,255,255,0.2);
      --border:rgba(255,255,255,0.3);
      --text:#ffffff;
      --text-dim:#eeeeee;
      --accent:#ffcc00;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;
      color:var(--text);
      min-height:100vh;
      display:flex;
      background-color: #111; /* Fallback background */
    }

    #background-video {
        position: fixed;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        z-index: -1;
        transform: translateX(-50%) translateY(-50%);
        background-size: cover;
        opacity: 0.7;
    }

    /* Sidebar / Mobile Navbar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100vh;
      background: rgba(20, 20, 30, 0.6);
      backdrop-filter: blur(10px);
      padding-top: 80px;
      border-right: 1px solid var(--border);
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      z-index: 50;
    }
    .navbar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .navbar li {
      margin: 20px 0;
    }
    .navbar a {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 20px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      border-radius: 12px;
      transition: all 0.3s;
    }
    .navbar a:hover {
      background: rgba(255,255,255,0.1);
    }
    .navbar a.active {
        background: var(--accent);
        color: #111;
    }
    .navbar svg {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    /* Content wrapper */
    .content {
      flex: 1;
      margin-left: 220px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header */
    .header{position:sticky;top:0;z-index:40;background:rgba(20,20,30,0.6);backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
    .header-inner{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr minmax(300px,700px) 1fr;gap:12px;align-items:center;padding:12px 16px}

    /* Search cluster */
    .search-wrap{display:flex;align-items:center;gap:12px;justify-self:center;width:100%}
    .search-form{display:flex;align-items:stretch;width:100%}

    .search-field{flex:1;display:flex;align-items:center;gap:8px;background:var(--muted);border:1px solid var(--border);border-right:none;border-radius:24px 0 0 24px;padding:0 12px 0 14px;position:relative;transition:all 0.3s ease}
    .search-field:focus-within{outline:2px solid var(--accent);outline-offset:2px;background:rgba(255,255,255,0.4)}

    .search-input{flex:1;background:transparent;border:none;color:var(--text);font-size:16px;line-height:40px;height:40px}
    .search-input:focus{outline:none}

    .icon{display:inline-flex;width:20px;height:20px;align-items:center;justify-content:center;opacity:.9}
    .divider{width:1px;background:var(--border);height:24px;margin:0 4px}

    .clear-btn,.voice-btn,.search-btn{display:inline-flex;align-items:center;justify-content:center;border:none;cursor:pointer;transition:all 0.2s ease}
    .clear-btn{width:32px;height:40px;color:var(--text);opacity:.75;background:transparent}
    .clear-btn:hover{opacity:1;transform:scale(1.1)}

    .voice-btn{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg, #ff512f, #dd2476);color:white;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
    .voice-btn:hover{transform:scale(1.1)}

    .search-btn{min-width:64px;height:40px;border-radius:0 24px 24px 0;background:linear-gradient(135deg, #36d1dc, #5b86e5);color:white;font-weight:bold;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
    .search-btn:hover{transform:scale(1.05)}
    
    /* Suggestions dropdown */
    .suggest{position:absolute;top:44px;left:0;right:0;background:rgba(30,30,40,0.85);backdrop-filter: blur(5px);border:1px solid var(--border);border-radius:12px;padding:6px 0;box-shadow:0 8px 24px rgba(0,0,0,.35);display:none;max-height:60vh;overflow:auto; z-index: 10;}
    .suggest.open{display:block}
    .s-item{display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;transition:background 0.2s}
    .s-item:hover,.s-item.active{background:rgba(255,255,255,0.1)}
    .s-text{color:#fff}
    .s-text strong { font-weight: 600; color: var(--accent); }


    /* Misc */
    .logo{font-weight:700;letter-spacing:.4px;font-size:20px;color:#fff; cursor: pointer;}
    .logo span{color:var(--accent)}
    .right{justify-self:end;display:flex;gap:10px}
    .kbd{font:12px/1.6 ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;border:1px solid var(--border);border-bottom-width:3px;border-radius:6px;background:rgba(255,255,255,0.15);padding:.2rem .35rem;color:var(--text)}

    /* Voice Search Modal */
    .voice-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .voice-modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }
    .voice-modal-content {
      text-align: center;
      color: white;
    }
    .mic-icon-pulsing {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff512f, #dd2476);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 81, 47, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(255, 81, 47, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 81, 47, 0); }
    }
    #voiceStatus {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    .voice-transcript {
        font-size: 18px;
        color: var(--text-dim);
        min-height: 27px;
    }

    /* Custom Alert */
    .custom-alert-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        display: none; /* Hidden by default */
        align-items: center;
        justify-content: center;
        z-index: 101;
    }
    .custom-alert-box {
        background: linear-gradient(135deg, #414345, #232526);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        text-align: center;
        max-width: 90%;
        width: 320px;
        border: 1px solid var(--border);
    }
    .custom-alert-box p {
        margin: 0 0 20px;
        font-size: 16px;
        color: var(--text);
    }
    .custom-alert-box button {
        background: linear-gradient(135deg, #36d1dc, #5b86e5);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s;
    }
    .custom-alert-box button:hover {
        transform: scale(1.05);
    }

    /* Video Grid & Sections */
    .section-title {
        font-size: 22px;
        margin-bottom: 16px;
        margin-top: 40px;
        color: var(--text);
        border-bottom: 2px solid var(--accent);
        padding-bottom: 8px;
        display: inline-block;
    }
    .section-title:first-of-type {
        margin-top: 0;
    }
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 24px 0;
    }
    .video-card {
      background: var(--panel);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid var(--border);
    }
    .video-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .thumbnail-container {
      position: relative;
    }
    .thumbnail {
      width: 100%;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      display: block;
      background: #333;
    }
    .video-info {
      padding: 12px;
    }
    .video-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--text);
      margin: 0 0 8px;
      line-height: 1.3;
      height: 42px; /* for 2 lines */
      overflow: hidden;
    }
    .video-meta {
      font-size: 14px;
      color: var(--text-dim);
      margin: 4px 0 0;
    }

    /* Video Player Modal */
    .video-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none; /* Hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 102; /* Above alert */
    }
    .video-modal-content {
      position: relative;
      width: 90%;
      max-width: 960px;
      background: #181818;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .video-modal-content .close-btn {
      position: absolute;
      top: -15px;
      right: -15px;
      width: 36px;
      height: 36px;
      background: white;
      color: black;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      z-index: 1;
      transition: transform 0.2s;
    }
    .video-modal-content .close-btn:hover {
        transform: scale(1.1);
    }
    #videoPlayer {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 8px;
      background: #000;
      border: none;
    }
    #videoTitle {
      color: white;
      margin: 15px 0 5px;
      font-size: 20px;
    }
    #videoChannel {
      color: var(--text-dim);
      margin: 0;
      font-size: 16px;
    }
    
    /* --- Upload Modal Styles --- */
    .upload-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 103; /* Highest z-index */
      transition: opacity 0.3s ease;
    }
    .upload-modal-content {
      background: linear-gradient(145deg, #2b2b3e, #1e1e2d);
      padding: 24px 32px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 550px;
      border: 1px solid var(--border);
      position: relative;
    }
    .upload-modal-content .close-btn {
      top: 15px;
      right: 15px;
    }
    .upload-modal-content h2 {
      margin-top: 0;
      margin-bottom: 24px;
      text-align: center;
      color: var(--text);
      font-weight: 500;
    }
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      margin-bottom: 20px;
    }
    .drop-zone.dragover {
      background-color: rgba(255, 255, 255, 0.1);
      border-color: var(--accent);
    }
    .drop-zone p {
      margin: 0;
      font-size: 16px;
      color: var(--text-dim);
    }
    .drop-zone .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 15px;
      opacity: 0.7;
    }
    #videoFileInput {
      display: none;
    }
    #fileName {
      margin-top: 15px;
      font-style: italic;
      color: var(--accent);
      min-height: 20px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-dim);
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--muted);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 16px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.5);
    }
    #uploadBtn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #36d1dc, #5b86e5);
      color: white;
      transition: transform 0.2s;
    }
    #uploadBtn:hover {
      transform: scale(1.02);
    }
    #uploadBtn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }
    .progress-container {
        display: none;
        margin-top: 20px;
    }
    .progress-bar {
        width: 100%;
        background-color: var(--muted);
        border-radius: 5px;
        overflow: hidden;
    }
    .progress-bar-inner {
        width: 0%;
        height: 10px;
        background-color: var(--accent);
        transition: width 0.4s ease;
    }
    #uploadStatus {
        text-align: center;
        margin-top: 8px;
        color: var(--text-dim);
    }

    /* Mobile view */
    @media (max-width:760px){
      .navbar {
        top: auto;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 60px;
        padding-top: 0;
        background: rgba(20, 20, 30, 0.8);
        display: flex;
        align-items: center;
        justify-content: space-around;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        border-right: none;
        border-top: 1px solid var(--border);
      }
      .navbar ul {
        display: flex;
        width: 100%;
        justify-content: space-around;
      }
      .navbar li {
        margin: 0;
      }
      .navbar a {
        flex-direction: column;
        font-size: 12px;
        padding: 8px 5px;
        gap: 5px;
        border-radius: 8px;
      }
      .content {margin-left: 0; margin-bottom: 70px;}
      .header-inner{
        grid-template-columns:1fr;
        max-width: 100%;
        padding: 8px 12px;
      }
      .logo {display:none;} /* Hide logo on mobile to make space for search */
      .right{display:none}

      /* Single column video grid on mobile */
      .video-grid { grid-template-columns: 1fr; }
      
      .video-modal-content { 
        width: 95%;
        padding: 10px;
      }
      /* Position close button inside the modal on mobile for easier access */
      .video-modal-content .close-btn {
        top: 5px;
        right: 5px;
        width: 32px;
        height: 32px;
        font-size: 20px;
        background: rgba(0,0,0,0.5);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
      }
      #videoTitle { font-size: 16px; }
      #videoChannel { font-size: 14px; }
      .section-title { font-size: 20px; }
      .upload-modal-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <video autoplay loop muted playsinline id="background-video">
    <source src="Ocean Sea Waves _ Drone Aerial View _ Free stock footage _ Free HD Videos - no copyright.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <nav class="navbar">
    <ul>
      <li><a href="#" class="active" onclick="showHomePage()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.1L1 12h3v9h6v-6h4v6h6v-9h3L12 2.1z"/></svg>
        Home
      </a></li>
      <li><a href="#" onclick="showSearchPage()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM10 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>
        Search
      </a></li>
      <li><a href="#" onclick="openUploadModal()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
        Upload
      </a></li>
      <li><a href="#" onclick="showAllVideos()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
        Browse
      </a></li>
      <li><a href="#" onclick="showMyVideos()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg>
        My Videos
      </a></li>
    </ul>
  </nav>

  <div class="content">
    <header class="header">
      <div class="header-inner">
        <div class="logo" id="logo">
            <img src="asimsaad.png" alt="EduTube Logo" style="height:40px; vertical-align:middle; border-radius: 8px;">
        </div>


        <div class="search-wrap">
          <form id="searchForm" class="search-form" autocomplete="off">
            <div class="search-field">
              <span class="icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM10 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>
              </span>
              <input id="searchInput" class="search-input" type="text" placeholder="Search..." />
              <button type="button" id="clearBtn" class="clear-btn" hidden>
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.7 2.88 18.29 9.17 12 2.88 5.71 4.29 4.29 10.59 10.6l6.3-6.31z"/></svg>
              </button>
              <span class="divider"></span>
              <button type="button" id="voiceBtn" class="voice-btn">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19.93V22h2v-2.07A8.001 8.001 0 0 0 20 12h-2a6 6 0 1 1-12 0H4a8.001 8.001 0 0 0 7 7.93z"/></svg>
              </button>
              <div id="suggest" class="suggest"></div>
            </div>
            <button id="searchBtn" class="search-btn" type="submit">Search</button>
          </form>
        </div>

        <div class="right">
        </div>
      </div>
    </header>

    <main style="max-width:1200px;margin:24px auto;padding:0 16px;color:var(--text-dim); width: 100%;">
        <div id="homePageContent">
            <h2 class="section-title">Community Videos</h2>
            <div id="communityGrid" class="video-grid"></div>

            <h2 class="section-title">What is...</h2>
            <div id="whatIsGrid" class="video-grid"></div>

            <h2 class="section-title">How to...</h2>
            <div id="howToGrid" class="video-grid"></div>

            <h2 class="section-title">Free Courses</h2>
            <div id="coursesGrid" class="video-grid"></div>
        </div>
        
        <div id="searchResultsContent" style="display: none;">
            <h2 id="main-title" class="section-title">Search Results</h2>
            <div id="videoGrid" class="video-grid"></div>
        </div>
    </main>
  </div>

  <div id="voiceModal" class="voice-modal-overlay">
    <div class="voice-modal-content">
      <div id="micIcon" class="mic-icon-pulsing">
        <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor"><path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19.93V22h2v-2.07A8.001 8.001 0 0 0 20 12h-2a6 6 0 1 1-12 0H4a8.001 8.001 0 0 0 7 7.93z"/></svg>
      </div>
      <p id="voiceStatus">Listening...</p>
      <p id="voiceTranscript" class="voice-transcript"></p>
    </div>
  </div>

  <div id="customAlert" class="custom-alert-overlay">
      <div class="custom-alert-box">
          <p id="customAlertMessage"></p>
          <button id="customAlertClose">OK</button>
      </div>
  </div>

  <div id="videoPlayerModal" class="video-modal-overlay">
    <div class="video-modal-content">
      <button id="closeVideoModal" class="close-btn">Ã—</button>
      <iframe id="videoPlayer" 
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen>
      </iframe>
      <h3 id="videoTitle"></h3>
      <p id="videoChannel"></p>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="uploadModal" class="upload-modal-overlay">
    <div class="upload-modal-content">
      <button id="closeUploadModal" class="close-btn">Ã—</button>
      <h2>Upload your Video</h2>
      <form id="uploadForm">
        <div id="dropZone" class="drop-zone">
            <div class="upload-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </div>
          <p>Drag & Drop your video here</p>
          <p style="font-size: 14px; opacity: 0.7;">or click to select file</p>
          <p id="fileName"></p>
        </div>
        <input type="file" id="videoFileInput" accept="video/*">
        
        <div class="form-group">
          <label for="videoTitleInput">Title</label>
          <input type="text" id="videoTitleInput" placeholder="Enter a title for your video" required>
        </div>
        
        <div class="form-group">
          <label for="videoDescInput">Description</label>
          <textarea id="videoDescInput" placeholder="Tell viewers about your video"></textarea>
        </div>
        
        <button type="submit" id="uploadBtn">Upload</button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progressBarInner"></div>
            </div>
            <p id="uploadStatus"></p>
        </div>
      </form>
    </div>
  </div>

  <script>
    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyDGvNmQ--P0HetZzBMJvyQyqOAJvap2Z-k",
      authDomain: "nextlearn-fe31f.firebaseapp.com",
      projectId: "nextlearn-fe31f",
      storageBucket: "nextlearn-fe31f.firebasestorage.app",
      messagingSenderId: "717511823549",
      appId: "1:717511823549:web:2e850018aad9e6b0fce7d4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // --- YOUTUBE API SETUP ---
    // IMPORTANT: Replace 'YOUR_API_KEY_HERE' with your actual YouTube Data API v3 key.
    const YOUTUBE_API_KEY = 'AIzaSyCTXF1F9lcKag8qbSP1KgMwaLyUNKYomPM';
    const API_BASE_URL = 'https://www.googleapis.com/youtube/v3/search';

    // --- Keywords for Home Page Sections ---
    const whatIsQueries = [
        'what is computer science engineering', 'what is artificial intelligence explained', 'what is programming for beginners', 'what is coding', 'what are data structures', 'what are algorithms', 'what is machine learning', 'what is cloud computing'
    ];
    const howToQueries = [
        'how to get good career opportunities in IT', 'how to score 9+ CGPA in engineering', 'how to use AI for studies', 'how to prepare for technical interviews', 'how to build a strong resume for tech jobs', 'study tips for engineering students', 'how to learn coding fast', 'how to manage time in college'
    ];
    const freeCoursesQueries = [
        'free html full course', 'free css full course', 'free c programming full course', 'free python full course for beginners', 'free javascript full course', 'free data structures and algorithms course', 'free machine learning course', 'free java full course'
    ];
    
    let suggestionKeywords = []; // Will be populated from fetched video titles
    
    // Cache for faster loading
    const videoCache = new Map();
    const cacheExpiry = 10 * 60 * 1000; // 10 minutes

    // --- DOM Elements ---
    const input = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const suggest = document.getElementById('suggest');
    const customAlert = document.getElementById('customAlert');
    const customAlertMessage = document.getElementById('customAlertMessage');
    const customAlertClose = document.getElementById('customAlertClose');
    const searchForm = document.getElementById('searchForm');
    
    // Page content containers
    const homePageContent = document.getElementById('homePageContent');
    const searchResultsContent = document.getElementById('searchResultsContent');
    
    // Video grids
    const communityGrid = document.getElementById('communityGrid');
    const whatIsGrid = document.getElementById('whatIsGrid');
    const howToGrid = document.getElementById('howToGrid');
    const coursesGrid = document.getElementById('coursesGrid');
    const videoGrid = document.getElementById('videoGrid'); // For search results
    const mainTitle = document.getElementById('main-title'); // For search results title
    
    // --- Custom Alert Logic ---
    function showCustomAlert(message) {
        customAlertMessage.textContent = message;
        customAlert.style.display = 'flex';
    }
    customAlertClose.addEventListener('click', () => {
        customAlert.style.display = 'none';
    });
    
    // --- Main Search Logic ---
    searchForm.addEventListener('submit', e => {
        e.preventDefault();
        const query = input.value.trim();
        if (query) {
            searchYouTube(query);
        }
        suggest.classList.remove('open');
    });

    // --- Voice Recognition (Web Speech API) ---
    const voiceBtn = document.getElementById("voiceBtn");
    const voiceModal = document.getElementById('voiceModal');
    const voiceStatus = document.getElementById('voiceStatus');
    const voiceTranscript = document.getElementById('voiceTranscript');
    
    let recognition;
    if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = "en-IN";
      recognition.continuous = false; 
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        voiceStatus.textContent = "Listening...";
        voiceTranscript.textContent = "Speak now...";
        voiceModal.style.display = 'flex';
        setTimeout(() => voiceModal.classList.add('visible'), 10);
      };

      recognition.onend = () => {
        voiceModal.classList.remove('visible');
        setTimeout(() => { if(voiceModal.style.display === 'flex') voiceModal.style.display = 'none'; }, 300);
      };
      
      recognition.onerror = (event) => {
        let errorMessage = "An error occurred during recognition.";
        if (event.error === 'no-speech') {
          errorMessage = "No speech was detected. Please try again.";
        } else if (event.error === 'audio-capture') {
          errorMessage = "Microphone not found. Ensure it's connected and enabled.";
        } else if (event.error === 'not-allowed') {
          errorMessage = "Permission to use microphone was denied. Please allow access in browser settings.";
        }
        voiceStatus.textContent = "Error";
        voiceTranscript.textContent = errorMessage;
      };

      recognition.onresult = (event) => {
        let interim_transcript = "";
        let final_transcript = "";

        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            final_transcript += event.results[i][0].transcript;
          } else {
            interim_transcript += event.results[i][0].transcript;
          }
        }
        
        voiceTranscript.textContent = interim_transcript || "Processing...";

        if (final_transcript) {
          input.value = final_transcript;
          clearBtn.hidden = false;
          if(recognition) recognition.stop();
          searchYouTube(final_transcript);
        }
      };

      voiceBtn.addEventListener("click", () => {
        try {
          recognition.start();
        } catch(e) {
          if (e.name !== 'InvalidStateError') {
            console.error("Could not start recognition: ", e);
            showCustomAlert("Could not start voice recognition.");
          }
        }
      });

    } else {
      voiceBtn.addEventListener("click", () => {
        showCustomAlert("Sorry, your browser does not support speech recognition.");
      });
    }

    // --- Video Player Logic ---
    const videoPlayerModal = document.getElementById('videoPlayerModal');
    const closeVideoModalBtn = document.getElementById('closeVideoModal');
    const videoPlayer = document.getElementById('videoPlayer');
    const videoTitle = document.getElementById('videoTitle');
    const videoChannel = document.getElementById('videoChannel');

    function openVideoPlayer(item) {
        if (item) {
            let embedUrl = '';
            if (item.type === 'video') {
                embedUrl = `https://www.youtube.com/embed/${item.id}?autoplay=1&rel=0`;
            } else { // playlist
                embedUrl = `https://www.youtube.com/embed/videoseries?list=${item.id}&autoplay=1&rel=0`;
            }
            videoPlayer.src = embedUrl;
            videoTitle.textContent = item.title;
            videoChannel.textContent = item.channel;
            videoPlayerModal.style.display = 'flex';
        }
    }

    function closeVideoPlayer() {
        videoPlayer.src = ''; // This stops the video in an iframe
        videoPlayerModal.style.display = 'none';
    }

    closeVideoModalBtn.addEventListener('click', closeVideoPlayer);
    videoPlayerModal.addEventListener('click', (e) => {
        if (e.target === videoPlayerModal) closeVideoPlayer();
    });

    // --- Upload Modal Logic ---
    const uploadModal = document.getElementById('uploadModal');
    const closeUploadModalBtn = document.getElementById('closeUploadModal');
    const uploadForm = document.getElementById('uploadForm');
    const videoFileInput = document.getElementById('videoFileInput');
    const dropZone = document.getElementById('dropZone');
    const fileNameDisplay = document.getElementById('fileName');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBarInner = document.getElementById('progressBarInner');
    const uploadStatus = document.getElementById('uploadStatus');

    closeUploadModalBtn.addEventListener('click', () => {
        uploadModal.style.display = 'none';
        resetUploadForm();
    });

    uploadModal.addEventListener('click', (e) => {
        if (e.target === uploadModal) {
            uploadModal.style.display = 'none';
            resetUploadForm();
        }
    });

    // Drag and Drop
    dropZone.addEventListener('click', () => videoFileInput.click());
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            videoFileInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    videoFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleFileSelect(file);
        }
    });
    
    function handleFileSelect(file) {
        if (file && file.type.startsWith('video/')) {
            fileNameDisplay.textContent = `Selected: ${file.name}`;
        } else {
            fileNameDisplay.textContent = 'Please select a valid video file.';
            videoFileInput.value = ''; // Clear invalid file
        }
    }
    
    function resetUploadForm() {
        uploadForm.reset();
        fileNameDisplay.textContent = '';
        progressContainer.style.display = 'none';
        progressBarInner.style.width = '0%';
        uploadStatus.textContent = '';
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload';
    }
    
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = videoFileInput.files[0];
        const title = document.getElementById('videoTitleInput').value;
        const description = document.getElementById('videoDescInput').value;

        if (!file) {
            showCustomAlert('Please select a video file to upload.');
            return;
        }
        if (!title.trim()) {
            showCustomAlert('Please enter a title for your video.');
            return;
        }

        // Validate file type
        const validTypes = ['video/mp4', 'video/webm', 'video/quicktime', 'video/avi'];
        if (!validTypes.includes(file.type)) {
            showCustomAlert('Please upload a valid video file (MP4, WebM, MOV, or AVI).');
            return;
        }

        // Check file size and suggest compression for large files
        const maxSize = 100 * 1024 * 1024; // 100MB for faster uploads
        if (file.size > maxSize) {
            const sizeMB = (file.size / (1024 * 1024)).toFixed(1);
            showCustomAlert(`File is ${sizeMB}MB which may upload slowly.\n\nðŸ’¡ Tips for faster uploads:\nâ€¢ Compress video to under 100MB\nâ€¢ Use MP4 format\nâ€¢ Lower resolution (720p recommended)\n\nContinue anyway?`);
            // Don't return, let them continue if they want
        }
        
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'Uploading...';
        progressContainer.style.display = 'block';
        progressBarInner.style.width = '0%';
        uploadStatus.textContent = 'Starting direct upload to Firebase...';
        
        console.log('ï¿½ Starting direct Firebase upload', {
            fileName: file.name,
            fileType: file.type,
            fileSize: `${(file.size / (1024 * 1024)).toFixed(2)} MB`
        });

        try {
            // Generate unique video ID
            const videoId = 'video_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const extension = file.name.split('.').pop();
            const videoFileName = `${videoId}.${extension}`;
            
            // Create Firebase storage reference with optimized settings
            const videoRef = storage.ref(`videos/${videoFileName}`);
            
            // Configure upload metadata for faster processing
            const metadata = {
                contentType: file.type,
                cacheControl: 'public,max-age=3600',
                customMetadata: {
                    'uploadedAt': new Date().toISOString(),
                    'originalName': file.name,
                    'size': file.size.toString()
                }
            };
            
            // Start optimized upload with chunking
            const uploadTask = videoRef.put(file, metadata);
            
            // Monitor upload progress with speed tracking
            let startTime = Date.now();
            let lastBytes = 0;
            let lastTime = startTime;
            
            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    const currentTime = Date.now();
                    const bytesTransferred = snapshot.bytesTransferred;
                    
                    // Calculate upload speed
                    const timeDiff = (currentTime - lastTime) / 1000; // seconds
                    const bytesDiff = bytesTransferred - lastBytes;
                    const speed = timeDiff > 0 ? bytesDiff / timeDiff : 0; // bytes per second
                    const speedMBps = (speed / (1024 * 1024)).toFixed(1); // MB/s
                    
                    // Calculate ETA
                    const remainingBytes = snapshot.totalBytes - bytesTransferred;
                    const eta = speed > 0 ? Math.round(remainingBytes / speed) : 0;
                    const etaText = eta > 60 ? `${Math.round(eta/60)}m` : `${eta}s`;
                    
                    progressBarInner.style.width = progress + '%';
                    
                    if (progress < 99) {
                        uploadStatus.textContent = `âš¡ ${Math.round(progress)}% â€¢ ${speedMBps} MB/s â€¢ ETA: ${etaText}`;
                    } else {
                        uploadStatus.textContent = 'ðŸ”„ Finalizing upload...';
                    }
                    
                    // Update tracking variables
                    lastBytes = bytesTransferred;
                    lastTime = currentTime;
                }, 
                (error) => {
                    console.error('Firebase upload error:', error);
                    throw new Error('Upload to Firebase failed: ' + error.message);
                }, 
                async () => {
                    try {
                        // Get download URL
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        
                        uploadStatus.textContent = 'âœ… Upload Complete!';
                        uploadBtn.textContent = 'Done!';
                        
                        console.log('âœ… Video uploaded to Firebase successfully!');
                        console.log('ðŸ”— Video URL:', downloadURL);
                        console.log('ðŸ“ Firebase Path:', `videos/${videoFileName}`);
                        
                        // Show success message with video URL
                        showCustomAlert(`ðŸŽ‰ Video uploaded successfully to Firebase!\n\nðŸ“± Your video is now stored in the cloud and accessible worldwide.\n\nðŸ”— Video URL: ${downloadURL.substring(0, 50)}...`);
                        
                        setTimeout(() => {
                            uploadModal.style.display = 'none';
                            resetUploadForm();
                        }, 3000);
                        
                    } catch (error) {
                        console.error('Error getting download URL:', error);
                        throw error;
                    }
                }
            );

        } catch (error) {
            console.error('Upload error:', error);
            showCustomAlert(`Upload failed: ${error.message}`);
            uploadStatus.textContent = 'Upload failed. Please try again.';
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload';
            progressBarInner.style.width = '0%';
        }
    });


    // --- YouTube API and Video Rendering ---
    
    function shuffleArray(array) {
      let currentIndex = array.length, randomIndex;
      while (currentIndex !== 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
      }
      return array;
    }

    function createVideoCard(item) {
        const videoCard = document.createElement('div');
        videoCard.className = 'video-card';
        videoCard.onclick = () => openVideoPlayer(item);

        const itemType = item.type === 'playlist' ? 'Playlist' : 'Video';
        // Preload thumbnail for faster appearance
        const img = new Image();
        img.src = item.thumbnailUrl;
        
        videoCard.innerHTML = `
            <div class="thumbnail-container">
                <img src="${item.thumbnailUrl}" alt="${item.title}" class="thumbnail" loading="eager" onerror="this.onerror=null;this.src='https://placehold.co/600x400/333/fff?text=${itemType}';">
            </div>
            <div class="video-info">
                <h3 class="video-title">${item.title}</h3>
                <p class="video-meta">${item.channel}</p>
                <p class="video-meta">${item.uploaded}</p>
            </div>
        `;
        return videoCard;
    }
    
    function renderVideoGrid(videos, gridElement, title) {
        if (title) mainTitle.textContent = title;
        gridElement.innerHTML = '';
        if (videos.length === 0) {
            gridElement.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; font-size: 18px;">No videos found. Please try another search.</p>`;
        } else {
            // Use document fragment for faster DOM manipulation
            const fragment = document.createDocumentFragment();
            videos.forEach(video => {
                fragment.appendChild(createVideoCard(video));
            });
            gridElement.appendChild(fragment);
        }
    }

    // Optimized fetch function with caching
    async function fetchWithCache(url, cacheKey) {
        const cached = videoCache.get(cacheKey);
        if (cached && Date.now() - cached.timestamp < cacheExpiry) {
            return cached.data;
        }

        const response = await fetch(url);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        videoCache.set(cacheKey, { data, timestamp: Date.now() });
        return data;
    }

    // Fetches and renders a section on the home page with optimizations
    async function fetchAndRenderSection(queries, gridElement, type = 'video') {
        const shuffledQueries = shuffleArray([...queries]);
        const selectedQueries = shuffledQueries.slice(0, 2); // Reduced to 2 for more reliable loading
        const combinedQuery = selectedQueries.join(' OR ');
        const cacheKey = `${type}_${combinedQuery}`;
        const url = `${API_BASE_URL}?part=snippet&maxResults=12&q=${encodeURIComponent(combinedQuery)}&type=${type}&key=${YOUTUBE_API_KEY}&order=relevance&safeSearch=none`;
        
        // Clear grid and show loading
        gridElement.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; opacity: 0.7;">Loading videos...</p>';

        try {
            console.log(`Fetching ${type} videos with query: ${combinedQuery}`);
            
            const data = await fetchWithCache(url, cacheKey);
            
            console.log(`Received ${data.items ? data.items.length : 0} items for ${type}`);

            if (!data.items || data.items.length === 0) {
                gridElement.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-dim);">No ${type}s found for this section.</p>`;
                return;
            }

            const allItems = data.items.map(item => ({
                type: item.id.kind === 'youtube#video' ? 'video' : 'playlist',
                id: item.id.videoId || item.id.playlistId,
                title: item.snippet.title,
                channel: item.snippet.channelTitle,
                thumbnailUrl: item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                uploaded: `Published on ${new Date(item.snippet.publishedAt).toLocaleDateString()}`
            })).filter(item => item.id && item.title && item.thumbnailUrl); // Filter out incomplete items
            
            console.log(`Processed ${allItems.length} valid items for ${type}`);
            
            const titles = allItems.map(v => v.title);
            suggestionKeywords.push(...titles.flatMap(t => t.split(/\s+/)).filter(k => k.length > 3));
            suggestionKeywords = [...new Set(suggestionKeywords)];
            
            const itemsToDisplay = shuffleArray(allItems).slice(0, 6);
            
            // Clear loading message and render videos
            gridElement.innerHTML = '';
            renderVideoGrid(itemsToDisplay, gridElement);

        } catch (error) {
            console.error(`Error fetching section (${type}):`, error);
            
            if (error.message.includes('quotaExceeded')) {
                gridElement.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #ff9800;">YouTube API quota exceeded. Please try again later.</p>`;
            } else if (error.message.includes('keyInvalid')) {
                gridElement.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #ff4444;">Invalid YouTube API key. Please check your configuration.</p>`;
            } else {
                // Try fallback with single query
                console.log(`Trying fallback for ${type} section`);
                await fetchSectionFallback(queries, gridElement, type);
            }
        }
    }

    // Fallback function for when combined queries fail
    async function fetchSectionFallback(queries, gridElement, type = 'video') {
        try {
            const singleQuery = queries[0]; // Use first query as fallback
            const url = `${API_BASE_URL}?part=snippet&maxResults=6&q=${encodeURIComponent(singleQuery)}&type=${type}&key=${YOUTUBE_API_KEY}&order=relevance`;
            
            console.log(`Fallback fetch for ${type} with query: ${singleQuery}`);
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.items && data.items.length > 0) {
                const allItems = data.items.map(item => ({
                    type: item.id.kind === 'youtube#video' ? 'video' : 'playlist',
                    id: item.id.videoId || item.id.playlistId,
                    title: item.snippet.title,
                    channel: item.snippet.channelTitle,
                    thumbnailUrl: item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                    uploaded: `Published on ${new Date(item.snippet.publishedAt).toLocaleDateString()}`
                })).filter(item => item.id && item.title);
                
                gridElement.innerHTML = '';
                renderVideoGrid(allItems, gridElement);
                console.log(`Fallback successful for ${type}: ${allItems.length} items`);
            } else {
                gridElement.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-dim);">No ${type}s available at the moment.</p>`;
            }
        } catch (fallbackError) {
            console.error(`Fallback also failed for ${type}:`, fallbackError);
            gridElement.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: var(--text-dim);">Unable to load ${type}s. Please try refreshing the page.</p>`;
        }
    }
    
    function renderHomePage() {
        homePageContent.style.display = 'block';
        searchResultsContent.style.display = 'none';
        
        suggestionKeywords = [];
        
        console.log('Loading home page with API key:', YOUTUBE_API_KEY.substring(0, 10) + '...');
        
        // Load community videos first
        fetchCommunityVideos();
        
        // Load YouTube videos with better error handling
        if (YOUTUBE_API_KEY && YOUTUBE_API_KEY !== 'YOUR_API_KEY_HERE') {
            // Load sections sequentially to avoid rate limiting
            setTimeout(() => {
                fetchAndRenderSection(whatIsQueries, whatIsGrid, 'video');
            }, 100);
            
            setTimeout(() => {
                fetchAndRenderSection(howToQueries, howToGrid, 'video');
            }, 500);
            
            setTimeout(() => {
                fetchAndRenderSection(freeCoursesQueries, coursesGrid, 'playlist');
            }, 1000);
        } else {
            console.error('YouTube API key not found or invalid');
            whatIsGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-dim);">YouTube integration disabled. API key required.</p>';
            howToGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-dim);">YouTube integration disabled. API key required.</p>';
            coursesGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-dim);">YouTube integration disabled. API key required.</p>';
        }
    }

    async function searchYouTube(query) {
       if (!YOUTUBE_API_KEY || YOUTUBE_API_KEY === 'YOUR_API_KEY_HERE') {
            showCustomAlert('Please add your YouTube API Key to the script file to enable search.');
            return;
        }
        
        homePageContent.style.display = 'none';
        searchResultsContent.style.display = 'block';

        const cacheKey = `search_${query}`;
        const url = `${API_BASE_URL}?part=snippet&maxResults=20&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}&order=relevance`;
        mainTitle.textContent = `Searching for "${query}"...`;
        videoGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Searching...</p>';

        try {
            console.log('Searching YouTube with query:', query);
            const data = await fetchWithCache(url, cacheKey);
            
            if (!data.items || data.items.length === 0) {
                renderVideoGrid([], videoGrid, `No results found for "${query}"`);
                return;
            }
            
            const results = data.items.map(item => ({
                type: 'video',
                id: item.id.videoId,
                title: item.snippet.title,
                channel: item.snippet.channelTitle,
                thumbnailUrl: item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                uploaded: `Published on ${new Date(item.snippet.publishedAt).toLocaleDateString()}`
            })).filter(item => item.id && item.title);
            
            renderVideoGrid(results, videoGrid, `Results for "${query}"`);
            console.log(`Search completed: ${results.length} results`);

        } catch (error) {
            console.error("Error searching YouTube:", error);
            if (error.message.includes('quotaExceeded')) {
                showCustomAlert("YouTube API quota exceeded. Please try again later.");
                renderVideoGrid([], videoGrid, `No results for "${query}" - API limit reached`);
            } else if (error.message.includes('keyInvalid')) {
                showCustomAlert("Invalid YouTube API key. Please check your configuration.");
                renderVideoGrid([], videoGrid, `Search unavailable - Invalid API key`);
            } else {
                showCustomAlert("An error occurred during the search. Please try again.");
                renderVideoGrid([], videoGrid, `No results for "${query}"`);
            }
        }
    }

    function renderSuggestions(list){
      suggest.innerHTML = '';
      if(!list.length){
        suggest.classList.remove('open');
        return;
      }

      list.slice(0, 10).forEach(text=>{
        const row = document.createElement('div');
        row.className = 's-item';
        const query = input.value.toLowerCase();
        const highlightedText = text.replace(new RegExp(query, 'gi'), match => `<strong>${match}</strong>`);
        
        row.innerHTML = `<span class="icon" style="opacity: 0.6;"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM10 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg></span><span class="s-text">${highlightedText}</span>`;
        row.addEventListener('mousedown',()=>{
            input.value = text;
            searchYouTube(text);
            suggest.classList.remove('open');
        });
        suggest.appendChild(row);
      });
      suggest.classList.add('open');
    }

    input.addEventListener('input', () => {
      clearBtn.hidden = input.value.length === 0;
      const q = input.value.toLowerCase();
      if (q.length > 1) {
        const filteredSuggestions = suggestionKeywords.filter(k => k.toLowerCase().includes(q));
        renderSuggestions(filteredSuggestions);
      } else {
        renderSuggestions([]);
      }
    });
    
    clearBtn.addEventListener('click',()=>{
        input.value='';
        clearBtn.hidden=true;
        suggest.classList.remove('open');
    });

    input.addEventListener('blur',()=>{
        setTimeout(()=>suggest.classList.remove('open'),200);
    });

    // --- Navigation Functions ---
    function showHomePage() {
        // Update active nav link
        document.querySelectorAll('.navbar a').forEach(a => a.classList.remove('active'));
        document.querySelector('a[onclick="showHomePage()"]').classList.add('active');
        
        renderHomePage();
    }

    function showSearchPage() {
        // Update active nav link
        document.querySelectorAll('.navbar a').forEach(a => a.classList.remove('active'));
        document.querySelector('a[onclick="showSearchPage()"]').classList.add('active');
        
        // Focus on search input
        input.focus();
        
        // Show search results if there's a query
        if (input.value.trim()) {
            searchYouTube(input.value.trim());
        } else {
            homePageContent.style.display = 'none';
            searchResultsContent.style.display = 'block';
            mainTitle.textContent = 'Enter a search term';
            videoGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; font-size: 18px;">Start typing to search for videos...</p>';
        }
    }

    function openUploadModal() {
        uploadModal.style.display = 'flex';
    }

    async function showAllVideos() {
        // Update active nav link
        document.querySelectorAll('.navbar a').forEach(a => a.classList.remove('active'));
        document.querySelector('a[onclick="showAllVideos()"]').classList.add('active');
        
        homePageContent.style.display = 'none';
        searchResultsContent.style.display = 'block';
        mainTitle.textContent = 'All Community Videos';
        videoGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Loading all videos...</p>';

        try {
            const response = await fetch(`${window.location.origin}/api/videos`);
            if (!response.ok) {
                throw new Error('Could not fetch videos. Make sure the server is running.');
            }
            
            const allVideos = await response.json();
            
            if (allVideos.length === 0) {
                videoGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; font-size: 18px;">No videos available yet. <a href="#" onclick="openUploadModal()" style="color: var(--accent);">Be the first to upload!</a></p>';
            } else {
                // Create video cards for all community videos
                videoGrid.innerHTML = '';
                allVideos.forEach(video => {
                    const videoCard = document.createElement('div');
                    videoCard.className = 'video-card';
                    videoCard.onclick = () => playUploadedVideo(video.publicUrl, video.title, video);
                    
                    videoCard.innerHTML = `
                        <div class="thumbnail-container">
                            <img src="${video.thumbnailUrl}" alt="${video.title}" class="thumbnail" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/320x180/1a1a1a/ffffff?text=Video';">
                        </div>
                        <div class="video-info">
                            <h3 class="video-title">${video.title}</h3>
                            <p class="video-meta">${video.channel}</p>
                            <p class="video-meta">${video.views || 0} views â€¢ ${new Date(video.uploadedAt).toLocaleDateString()}</p>
                        </div>
                    `;
                    videoGrid.appendChild(videoCard);
                });
            }
        } catch (error) {
            console.error('Error fetching all videos:', error);
            videoGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #ff4444;">Error loading videos: ${error.message}</p>`;
        }
    }

    async function showMyVideos() {
        // Update active nav link
        document.querySelectorAll('.navbar a').forEach(a => a.classList.remove('active'));
        document.querySelector('a[onclick="showMyVideos()"]').classList.add('active');
        
        homePageContent.style.display = 'none';
        searchResultsContent.style.display = 'block';
        mainTitle.textContent = 'My Uploaded Videos';
        videoGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Loading your videos...</p>';

        try {
            const response = await fetch(`${window.location.origin}/api/my-videos`);
            if (!response.ok) {
                throw new Error('Could not fetch your videos. Make sure the server is running.');
            }
            
            const myVideos = await response.json();
            
            if (myVideos.length === 0) {
                videoGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; font-size: 18px;">No videos uploaded yet. <a href="#" onclick="openUploadModal()" style="color: var(--accent);">Upload your first video!</a></p>';
            } else {
                // Create custom video cards for uploaded videos
                videoGrid.innerHTML = '';
                myVideos.forEach(video => {
                    const videoCard = document.createElement('div');
                    videoCard.className = 'video-card';
                    
                    videoCard.innerHTML = `
                        <div class="thumbnail-container">
                            <img src="${video.thumbnailUrl}" alt="${video.title}" class="thumbnail" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/320x180/1a1a1a/ffffff?text=Video';">
                            <div class="video-duration" style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">${video.views || 0} views</div>
                        </div>
                        <div class="video-info">
                            <h3 class="video-title">${video.title}</h3>
                            <p class="video-meta">${video.channel}</p>
                            <p class="video-meta">Uploaded ${new Date(video.uploadedAt).toLocaleDateString()}</p>
                            <div style="margin-top: 8px;">
                                <button onclick="event.stopPropagation(); playUploadedVideo('${video.publicUrl}', '${video.title}', ${JSON.stringify(video).replace(/"/g, '&quot;')})" style="background: var(--accent); color: black; border: none; padding: 4px 8px; border-radius: 4px; margin-right: 8px; cursor: pointer; font-size: 12px;">Play</button>
                                <button onclick="event.stopPropagation(); deleteVideo('${video.id}')" style="background: #ff4444; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                            </div>
                        </div>
                    `;
                    videoGrid.appendChild(videoCard);
                });
            }
        } catch (error) {
            console.error('Error fetching my videos:', error);
            videoGrid.innerHTML = `<p style="grid-column: 1 / -1; text-align: center; color: #ff4444;">Error loading videos: ${error.message}</p>`;
        }
    }

    function playUploadedVideo(videoUrl, title, videoData = null) {
        // Create a simple video player for uploaded videos
        const videoModal = document.getElementById('videoPlayerModal');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoTitle = document.getElementById('videoTitle');
        const videoChannel = document.getElementById('videoChannel');
        
        // Replace iframe with video element for direct video playback
        videoPlayer.style.display = 'none';
        
        let customVideoPlayer = document.getElementById('customVideoPlayer');
        if (!customVideoPlayer) {
            customVideoPlayer = document.createElement('video');
            customVideoPlayer.id = 'customVideoPlayer';
            customVideoPlayer.controls = true;
            customVideoPlayer.style.width = '100%';
            customVideoPlayer.style.height = '400px';
            customVideoPlayer.style.backgroundColor = '#000';
            customVideoPlayer.style.borderRadius = '8px';
            videoPlayer.parentNode.insertBefore(customVideoPlayer, videoPlayer);
        }
        
        customVideoPlayer.src = videoUrl;
        customVideoPlayer.style.display = 'block';
        videoTitle.textContent = title;
        
        if (videoData) {
            videoChannel.textContent = `${videoData.channel} â€¢ ${videoData.views || 0} views â€¢ ${new Date(videoData.uploadedAt).toLocaleDateString()}`;
            
            // Increment view count when video starts playing
            customVideoPlayer.addEventListener('play', async () => {
                try {
                    await fetch(`${window.location.origin}/api/videos/${videoData.id}`);
                } catch (error) {
                    console.log('Could not update view count:', error);
                }
            }, { once: true });
        } else {
            videoChannel.textContent = 'Your Upload';
        }
        
        videoModal.style.display = 'flex';
    }

    async function deleteVideo(videoId) {
        if (!confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
            return;
        }

        try {
            const response = await fetch(`${window.location.origin}/api/videos/${videoId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to delete video');
            }

            showCustomAlert('Video deleted successfully!');
            showMyVideos(); // Refresh the list
        } catch (error) {
            console.error('Error deleting video:', error);
            showCustomAlert(`Error deleting video: ${error.message}`);
        }
    }

    // Update close video modal to handle custom video player
    const originalCloseVideoPlayer = closeVideoPlayer;
    closeVideoPlayer = function() {
        const customVideoPlayer = document.getElementById('customVideoPlayer');
        if (customVideoPlayer) {
            customVideoPlayer.pause();
            customVideoPlayer.style.display = 'none';
        }
        document.getElementById('videoPlayer').style.display = 'block';
        originalCloseVideoPlayer();
    };

    // Initialize the app when page loads
    window.addEventListener('DOMContentLoaded', () => {
        console.log('Page loaded, initializing...');
        
        // Test API key on page load
        if (YOUTUBE_API_KEY && YOUTUBE_API_KEY !== 'YOUR_API_KEY_HERE') {
            // Test the API key with a simple request
            fetch(`${API_BASE_URL}?part=snippet&maxResults=1&q=test&type=video&key=${YOUTUBE_API_KEY}`)
                .then(response => {
                    if (!response.ok) {
                        console.error('API key test failed:', response.status);
                        showCustomAlert('YouTube API key appears to be invalid. Please check your configuration.');
                    } else {
                        console.log('YouTube API key validated successfully');
                    }
                })
                .catch(error => {
                    console.error('API key test error:', error);
                });
        }
        
        // Load home page
        renderHomePage();
    });
  </script>
</body>
</html>
