<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17524250047"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-17524250047');
</script>
  <!-- Authentication Check -->
  <script type="module" src="auth-check.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>EduTube - Curated Learning</title>
  <style>
    :root{
      --panel:rgba(255,255,255,0.1);
      --muted:rgba(255,255,255,0.2);
      --border:rgba(255,255,255,0.3);
      --text:#ffffff;
      --text-dim:#eeeeee;
      --accent:#ffcc00;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;
      color:var(--text);
      min-height:100vh;
      display:flex;
      background-color: #111; /* Fallback background */
    }

    #background-video {
        position: fixed;
        top: 50%;
        left: 50%;
        min-width: 100%;
        min-height: 100%;
        width: auto;
        height: auto;
        z-index: -1;
        transform: translateX(-50%) translateY(-50%);
        background-size: cover;
        opacity: 0.7;
    }

    /* Sidebar / Mobile Navbar */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      width: 220px;
      height: 100vh;
      background: rgba(20, 20, 30, 0.6);
      backdrop-filter: blur(10px);
      padding-top: 80px;
      border-right: 1px solid var(--border);
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
      z-index: 50;
    }
    .navbar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .navbar li {
      margin: 20px 0;
    }
    .navbar a {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 20px;
      color: white;
      text-decoration: none;
      font-weight: 500;
      border-radius: 12px;
      transition: all 0.3s;
    }
    .navbar a:hover {
      background: rgba(255,255,255,0.1);
    }
    .navbar a.active {
        background: var(--accent);
        color: #111;
    }
    .navbar svg {
      width: 24px;
      height: 24px;
      flex-shrink: 0;
    }

    /* Content wrapper */
    .content {
      flex: 1;
      margin-left: 220px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header */
    .header{position:sticky;top:0;z-index:40;background:rgba(20,20,30,0.6);backdrop-filter:blur(12px);border-bottom:1px solid var(--border)}
    .header-inner{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr minmax(300px,700px) 1fr;gap:12px;align-items:center;padding:12px 16px}

    /* Search cluster */
    .search-wrap{display:flex;align-items:center;gap:12px;justify-self:center;width:100%}
    .search-form{display:flex;align-items:stretch;width:100%}

    .search-field{flex:1;display:flex;align-items:center;gap:8px;background:var(--muted);border:1px solid var(--border);border-right:none;border-radius:24px 0 0 24px;padding:0 12px 0 14px;position:relative;transition:all 0.3s ease}
    .search-field:focus-within{outline:2px solid var(--accent);outline-offset:2px;background:rgba(255,255,255,0.4)}

    .search-input{flex:1;background:transparent;border:none;color:var(--text);font-size:16px;line-height:40px;height:40px}
    .search-input:focus{outline:none}

    .icon{display:inline-flex;width:20px;height:20px;align-items:center;justify-content:center;opacity:.9}
    .divider{width:1px;background:var(--border);height:24px;margin:0 4px}

    .clear-btn,.voice-btn,.search-btn{display:inline-flex;align-items:center;justify-content:center;border:none;cursor:pointer;transition:all 0.2s ease}
    .clear-btn{width:32px;height:40px;color:var(--text);opacity:.75;background:transparent}
    .clear-btn:hover{opacity:1;transform:scale(1.1)}

    .voice-btn{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg, #ff512f, #dd2476);color:white;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
    .voice-btn:hover{transform:scale(1.1)}

    .search-btn{min-width:64px;height:40px;border-radius:0 24px 24px 0;background:linear-gradient(135deg, #36d1dc, #5b86e5);color:white;font-weight:bold;border:none;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
    .search-btn:hover{transform:scale(1.05)}
    
    /* Suggestions dropdown */
    .suggest{position:absolute;top:44px;left:0;right:0;background:rgba(30,30,40,0.85);backdrop-filter: blur(5px);border:1px solid var(--border);border-radius:12px;padding:6px 0;box-shadow:0 8px 24px rgba(0,0,0,.35);display:none;max-height:60vh;overflow:auto; z-index: 10;}
    .suggest.open{display:block}
    .s-item{display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;transition:background 0.2s}
    .s-item:hover,.s-item.active{background:rgba(255,255,255,0.1)}
    .s-text{color:#fff}
    .s-text strong { font-weight: 600; color: var(--accent); }


    /* Misc */
    .logo{font-weight:700;letter-spacing:.4px;font-size:20px;color:#fff; cursor: pointer;}
    .logo span{color:var(--accent)}
    .right{justify-self:end;display:flex;gap:10px}
    .kbd{font:12px/1.6 ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;border:1px solid var(--border);border-bottom-width:3px;border-radius:6px;background:rgba(255,255,255,0.15);padding:.2rem .35rem;color:var(--text)}

    /* Voice Search Modal */
    .voice-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .voice-modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }
    .voice-modal-content {
      text-align: center;
      color: white;
    }
    .mic-icon-pulsing {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff512f, #dd2476);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 81, 47, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(255, 81, 47, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 81, 47, 0); }
    }
    #voiceStatus {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    .voice-transcript {
        font-size: 18px;
        color: var(--text-dim);
        min-height: 27px;
    }

    /* Custom Alert */
    .custom-alert-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        display: none; /* Hidden by default */
        align-items: center;
        justify-content: center;
        z-index: 101;
    }
    .custom-alert-box {
        background: linear-gradient(145deg, #2b2b3e, #1e1e2d);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        text-align: center;
        max-width: 90%;
        width: 320px;
        border: 1px solid var(--border);
    }
    .custom-alert-box p {
        margin: 0 0 20px;
        font-size: 16px;
        color: var(--text);
    }
    .custom-alert-box button {
        background: linear-gradient(135deg, #36d1dc, #5b86e5);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s;
    }
    .custom-alert-box button:hover {
        transform: scale(1.05);
    }

    /* Video Grid & Sections */
    .section-title {
        font-size: 22px;
        margin-bottom: 16px;
        margin-top: 40px;
        color: var(--text);
        border-bottom: 2px solid var(--accent);
        padding-bottom: 8px;
        display: inline-block;
    }
    .section-title:first-of-type {
        margin-top: 0;
    }
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 24px 0;
    }
    .video-card {
      background: var(--panel);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid var(--border);
    }
    .video-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .thumbnail-container {
      position: relative;
    }
    .thumbnail {
      width: 100%;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      display: block;
      background: #333;
    }
    .video-info {
      padding: 12px;
    }
    .video-title {
      font-size: 16px;
      font-weight: 500;
      color: var(--text);
      margin: 0 0 8px;
      line-height: 1.3;
      height: 42px; /* for 2 lines */
      overflow: hidden;
    }
    .video-meta {
      font-size: 14px;
      color: var(--text-dim);
      margin: 4px 0 0;
    }

    /* Video Player Modal */
    .video-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none; /* Hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 102; /* Above alert */
    }
    .video-modal-content {
      position: relative;
      width: 90%;
      max-width: 960px;
      background: #181818;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .video-modal-content .close-btn {
      position: absolute;
      top: -15px;
      right: -15px;
      width: 36px;
      height: 36px;
      background: white;
      color: black;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      z-index: 1;
      transition: transform 0.2s;
    }
    .video-modal-content .close-btn:hover {
        transform: scale(1.1);
    }
    #videoPlayer {
      width: 100%;
      aspect-ratio: 16 / 9;
      border-radius: 8px;
      background: #000;
      border: none;
    }
    #videoTitle {
      color: white;
      margin: 15px 0 5px;
      font-size: 20px;
    }
    #videoChannel {
      color: var(--text-dim);
      margin: 0;
      font-size: 16px;
    }
    
    /* --- Upload Modal Styles --- */
    .upload-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 103; /* Highest z-index */
      transition: opacity 0.3s ease;
    }
    .upload-modal-content {
      background: linear-gradient(145deg, #2b2b3e, #1e1e2d);
      padding: 24px 32px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      width: 90%;
      max-width: 550px;
      border: 1px solid var(--border);
      position: relative;
    }
    .upload-modal-content .close-btn {
      top: 15px;
      right: 15px;
    }
    .upload-modal-content h2 {
      margin-top: 0;
      margin-bottom: 24px;
      text-align: center;
      color: var(--text);
      font-weight: 500;
    }
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      margin-bottom: 20px;
    }
    .drop-zone.dragover {
      background-color: rgba(255, 255, 255, 0.1);
      border-color: var(--accent);
    }
    .drop-zone p {
      margin: 0;
      font-size: 16px;
      color: var(--text-dim);
    }
    .drop-zone .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 15px;
      opacity: 0.7;
    }
    #videoFileInput {
      display: none;
    }
    #fileName {
      margin-top: 15px;
      font-style: italic;
      color: var(--accent);
      min-height: 20px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-dim);
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--muted);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 16px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.5);
    }
    #uploadBtn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #36d1dc, #5b86e5);
      color: white;
      transition: transform 0.2s;
    }
    #uploadBtn:hover {
      transform: scale(1.02);
    }
    #uploadBtn:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }
    .progress-container {
        display: none;
        margin-top: 20px;
    }
    .progress-bar {
        width: 100%;
        background-color: var(--muted);
        border-radius: 5px;
        overflow: hidden;
    }
    .progress-bar-inner {
        width: 0%;
        height: 10px;
        background-color: var(--accent);
        transition: width 0.4s ease;
    }
    #uploadStatus {
        text-align: center;
        margin-top: 8px;
        color: var(--text-dim);
    }

    /* Mobile view */
    @media (max-width:760px){
      .navbar {
        top: auto;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 60px;
        padding-top: 0;
        background: rgba(20, 20, 30, 0.8);
        display: flex;
        align-items: center;
        justify-content: space-around;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        border-right: none;
        border-top: 1px solid var(--border);
      }
      .navbar ul {
        display: flex;
        width: 100%;
        justify-content: space-around;
      }
      .navbar li {
        margin: 0;
      }
      .navbar a {
        flex-direction: column;
        font-size: 12px;
        padding: 8px 5px;
        gap: 5px;
        border-radius: 8px;
      }
      .content {margin-left: 0; margin-bottom: 70px;}
      .header-inner{
        grid-template-columns:1fr;
        max-width: 100%;
        padding: 8px 12px;
      }
      .logo {display:none;} /* Hide logo on mobile to make space for search */
      .right{display:none}

      /* Single column video grid on mobile */
      .video-grid { grid-template-columns: 1fr; }
      
      .video-modal-content { 
        width: 95%;
        padding: 10px;
      }
      /* Position close button inside the modal on mobile for easier access */
      .video-modal-content .close-btn {
        top: 5px;
        right: 5px;
        width: 32px;
        height: 32px;
        font-size: 20px;
        background: rgba(0,0,0,0.5);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
      }
      #videoTitle { font-size: 16px; }
      #videoChannel { font-size: 14px; }
      .section-title { font-size: 20px; }
      .upload-modal-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <video autoplay loop muted playsinline id="background-video">
    <source src="Ocean Sea Waves _ Drone Aerial View _ Free stock footage _ Free HD Videos - no copyright.mp4" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <nav class="navbar">
    <ul>
      <li><a href="#" class="active" onclick="showHomePage()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.1L1 12h3v9h6v-6h4v6h6v-9h3L12 2.1z"/></svg>
        Home
      </a></li>
      <li><a href="#" onclick="showSearchPage()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM10 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>
        Search
      </a></li>
      <li><a href="#" onclick="openUploadModal()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
        Upload
      </a></li>
      <li><a href="#" onclick="showAllVideos()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
        Browse
      </a></li>
      <li><a href="#" onclick="showMyVideos()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg>
        My Videos
      </a></li>
    </ul>
  </nav>

  <div class="content">
    <header class="header">
      <div class="header-inner">
        <div class="logo" id="logo">
            <img src="asimsaad.png" alt="EduTube Logo" style="height:40px; vertical-align:middle; border-radius: 8px;">
        </div>


        <div class="search-wrap">
          <form id="searchForm" class="search-form" autocomplete="off">
            <div class="search-field">
              <span class="icon">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM10 15a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/></svg>
              </span>
              <input id="searchInput" class="search-input" type="text" placeholder="Search..." />
              <button type="button" id="clearBtn" class="clear-btn" hidden>
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.7 2.88 18.29 9.17 12 2.88 5.71 4.29 4.29 10.59 10.6l6.3-6.31z"/></svg>
              </button>
              <span class="divider"></span>
              <button type="button" id="voiceBtn" class="voice-btn">
                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19.93V22h2v-2.07A8.001 8.001 0 0 0 20 12h-2a6 6 0 1 1-12 0H4a8.001 8.001 0 0 0 7 7.93z"/></svg>
              </button>
              <div id="suggest" class="suggest"></div>
            </div>
            <button id="searchBtn" class="search-btn" type="submit">Search</button>
          </form>
        </div>

        <div class="right">
        </div>
      </div>
    </header>

    <main style="max-width:1200px;margin:24px auto;padding:0 16px;color:var(--text-dim);width:100%;">
        <div id="homePageContent"></div>
        <div id="searchResultsContent" style="display:none;">
            <h2 id="main-title" class="section-title">Search Results</h2>
            <div id="videoGrid" class="video-grid"></div>
        </div>
    </main>
  </div>

  <div id="voiceModal" class="voice-modal-overlay">
    <div class="voice-modal-content">
      <div id="micIcon" class="mic-icon-pulsing">
        <svg viewBox="0 0 24 24" width="48" height="48" fill="currentColor"><path d="M12 14a3 3 0 0 0 3-3V7a3 3 0 1 0-6 0v4a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19.93V22h2v-2.07A8.001 8.001 0 0 0 20 12h-2a6 6 0 1 1-12 0H4a8.001 8.001 0 0 0 7 7.93z"/></svg>
      </div>
      <p id="voiceStatus">Listening...</p>
      <p id="voiceTranscript" class="voice-transcript"></p>
    </div>
  </div>

  <div id="customAlert" class="custom-alert-overlay">
      <div class="custom-alert-box">
          <p id="customAlertMessage"></p>
          <button id="customAlertClose">OK</button>
      </div>
  </div>

  <div id="videoPlayerModal" class="video-modal-overlay">
    <div class="video-modal-content">
      <button id="closeVideoModal" class="close-btn">×</button>
      <iframe id="videoPlayer" 
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen>
      </iframe>
      <h3 id="videoTitle"></h3>
      <p id="videoChannel"></p>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="uploadModal" class="upload-modal-overlay">
    <div class="upload-modal-content">
      <button id="closeUploadModal" class="close-btn">×</button>
      <h2>Upload your Video</h2>
      <form id="uploadForm">
        <div id="dropZone" class="drop-zone">
            <div class="upload-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </div>
          <p>Drag & Drop your video here</p>
          <p style="font-size: 14px; opacity: 0.7;">or click to select file</p>
          <p id="fileName"></p>
        </div>
        <input type="file" id="videoFileInput" accept="video/*">
        
        <div class="form-group">
          <label for="videoTitleInput">Title</label>
          <input type="text" id="videoTitleInput" placeholder="Enter a title for your video" required>
        </div>
        
        <div class="form-group">
          <label for="videoDescInput">Description</label>
          <textarea id="videoDescInput" placeholder="Tell viewers about your video"></textarea>
        </div>
        
        <button type="submit" id="uploadBtn">Upload</button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progressBarInner"></div>
            </div>
            <p id="uploadStatus"></p>
        </div>
      </form>
    </div>
  </div>

  <script>
    // --- Firebase config (unchanged) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDGvNmQ--P0HetZzBMJvyQyqOAJvap2Z-k",
      authDomain: "nextlearn-fe31f.firebaseapp.com",
      projectId: "nextlearn-fe31f",
      storageBucket: "nextlearn-fe31f.firebasestorage.app",
      messagingSenderId: "717511823549",
      appId: "1:717511823549:web:2e850018aad9e6b0fce7d4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // --- YouTube basic setup (kept) ---
    const YOUTUBE_API_KEY = 'AIzaSyCTXF1F9lcKag8qbSP1KgMwaLyUNKYomPM';
    const API_BASE_URL = 'https://www.googleapis.com/youtube/v3/search';
    const VIDEOS_API_URL = 'https://www.googleapis.com/youtube/v3/videos';

    // Fallback videos
    const fallbackVideos = [
      { id:'oV74Najm6Nc', title:'Intro to Computer Science', channel:'CS Basics', publishedAt:'2023-01-01' },
      { id:'8mAITcNt710', title:'Data Structures Overview', channel:'Engg Concepts', publishedAt:'2023-02-10' },
      { id:'zOjov-2OZ0E', title:'Learn Python Fast', channel:'Programming Lectures', publishedAt:'2023-03-05' },
      { id:'pTB0EiLXUC8', title:'JavaScript Crash Course', channel:'Code Academy', publishedAt:'2023-03-20' },
      { id:'wE3fmFTtP9g', title:'Mechanical Engineering Basics', channel:'Mech Edu', publishedAt:'2023-04-01' },
      { id:'aircAruvnKk', title:'Machine Learning Intro', channel:'ML for Engineers', publishedAt:'2023-04-15' }
    ];

    // Educational filtering
    const ALLOWED_EDU_CATEGORY_IDS = new Set(['27','28','26']);
    const CONDITIONAL_CATEGORY_IDS = new Set(['25','20']);
    const POSITIVE_KEYWORDS = ['learn','learning','tutorial','course','class','education','study','how to','exam','lecture','revision','practice','training','guide','tips','engineering','science','math','physics','chemistry','biology','ai','machine learning','data structure','algorithm','quiz','assignment','project','bootcamp','career','internship','coding','programming','python','java','javascript','c++','html','css','sql'];
    const NEGATIVE_KEYWORDS = ['trailer','song','music','official video','challenge','prank','vlog','asmr','dance','lyrics','movie','status'];
    const hasPositive = t => POSITIVE_KEYWORDS.some(k=>t.includes(k));
    const hasNegative = t => NEGATIVE_KEYWORDS.some(k=>t.includes(k));
    function isEducational(video, detail){
      const t = video.title.toLowerCase();
      const d = (detail?.description||'');
      const cat = detail?.categoryId;
      if(!cat) return false;
      if(ALLOWED_EDU_CATEGORY_IDS.has(cat)) return !hasNegative(t)&&!hasNegative(d);
      if(CONDITIONAL_CATEGORY_IDS.has(cat)) return (hasPositive(t)||hasPositive(d)) && !hasNegative(t);
      return false;
    }

    // Cache
    const videoCache = new Map();
    const cacheExpiry = 10*60*1000;

    // DOM
    const input = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const suggest = document.getElementById('suggest');
    const customAlert = document.getElementById('customAlert');
    const customAlertMessage = document.getElementById('customAlertMessage');
    const customAlertClose = document.getElementById('customAlertClose');
    const searchForm = document.getElementById('searchForm');
    const homePageContent = document.getElementById('homePageContent');
    const searchResultsContent = document.getElementById('searchResultsContent');
    const videoGrid = document.getElementById('videoGrid');
    const mainTitle = document.getElementById('main-title');

    // State
    let suggestionKeywords = [];
    let currentSearchQuery = '';
    let nextPageToken = null;
    let isLoadingMore = false;

    // Utility
    function showCustomAlert(msg){ customAlertMessage.textContent = msg; customAlert.style.display='flex'; }
    customAlertClose.onclick=()=>customAlert.style.display='none';
    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){const j=Math.random()* (i+1) |0; [a[i],a[j]]=[a[j],a[i]];} return a;}
    async function fetchWithCache(url,key){
      const c=videoCache.get(key);
      if(c && Date.now()-c.timestamp<cacheExpiry) return c.data;
      const r=await fetch(url);
      if(!r.ok) throw new Error((await r.text())||'Request failed');
      const d=await r.json();
      videoCache.set(key,{data:d,timestamp:Date.now()});
      return d;
    }
    async function fetchVideoDetails(ids){
      if(!ids.length) return {};
      const details={};
      for(let i=0;i<ids.length;i+=50){
        const chunk=ids.slice(i,i+50);
        const key='vd_'+chunk.join(',');
        if(videoCache.has(key)&&Date.now()-videoCache.get(key).timestamp<cacheExpiry){
          Object.assign(details,videoCache.get(key).data); continue;
        }
        const url=`${VIDEOS_API_URL}?part=snippet&id=${chunk.join(',')}&key=${YOUTUBE_API_KEY}`;
        const resp=await fetch(url); if(!resp.ok) continue;
        const data=await resp.json();
        const mapped={};
        data.items?.forEach(v=>{
          mapped[v.id]={categoryId:v.snippet.categoryId,description:(v.snippet.description||'').toLowerCase()};
        });
        videoCache.set(key,{data:mapped,timestamp:Date.now()});
        Object.assign(details,mapped);
      }
      return details;
    }

    function createVideoCard(v){
      const el=document.createElement('div');
      el.className='video-card';
      el.onclick=()=>openVideoPlayer(v);
      el.innerHTML=`
        <div class="thumbnail-container">
          <img src="${v.thumbnailUrl}" class="thumbnail" alt="${v.title}"
               onerror="this.onerror=null;this.src='https://placehold.co/600x400/333/fff?text=Video';">
        </div>
        <div class="video-info">
          <h3 class="video-title">${v.title}</h3>
          <p class="video-meta">${v.channel}</p>
          <p class="video-meta">${v.uploaded}</p>
        </div>`;
      return el;
    }

    function renderVideoGrid(videos, grid, title){
      if(title) mainTitle.textContent=title;
      grid.innerHTML='';
      if(!videos.length){
        grid.innerHTML = `<p style="grid-column:1/-1;text-align:center;">No videos found.</p>`;
        return;
      }
      const frag=document.createDocumentFragment();
      videos.forEach(v=>frag.appendChild(createVideoCard(v)));
      grid.appendChild(frag);
    }

    function applyFallback(title){
      const vids = fallbackVideos.map(v=>({
        type:'video',
        id:v.id,
        title:v.title,
        channel:v.channel,
        thumbnailUrl:`https://i.ytimg.com/vi/${v.id}/hqdefault.jpg`,
        uploaded:`Published on ${new Date(v.publishedAt).toLocaleDateString()}`
      }));
      renderVideoGrid(vids, videoGrid, title);
    }

    function renderSkeletons(count=8){
      videoGrid.innerHTML='';
      for(let i=0;i<count;i++){
        const d=document.createElement('div');
        d.className='video-card';
        d.innerHTML=`<div class="thumbnail-container" style="background:#222;height:0;padding-top:56.25%;"></div>
          <div class="video-info">
            <div style="height:14px;background:#333;border-radius:4px;margin:6px 0;width:80%"></div>
            <div style="height:12px;background:#2b2b2b;border-radius:4px;width:55%"></div>
          </div>`;
        videoGrid.appendChild(d);
      }
    }

    async function searchYouTube(query, append=false){
      if(!YOUTUBE_API_KEY){ showCustomAlert('API key missing'); return; }
      if(!append){
        currentSearchQuery=query;
        nextPageToken=null;
        renderSkeletons();
        searchResultsContent.style.display='block';
        homePageContent.style.display='none';
        mainTitle.textContent=`Results for "${query}"`;
      }
      const pagePart = nextPageToken ? `&pageToken=${nextPageToken}`:'';
      const key=`search_${query}_${nextPageToken||'first'}`;
      const url=`${API_BASE_URL}?part=snippet&maxResults=25&q=${encodeURIComponent(query)}&type=video&key=${YOUTUBE_API_KEY}&safeSearch=moderate&order=relevance${pagePart}`;
      try{
        const data=await fetchWithCache(url,key);
        nextPageToken=data.nextPageToken||null;
        let items=(data.items||[]).map(it=>({
          type:'video',
          id:it.id.videoId,
          title:it.snippet.title,
          channel:it.snippet.channelTitle||'Channel',
          thumbnailUrl:it.snippet.thumbnails?.high?.url || it.snippet.thumbnails?.medium?.url,
          uploaded:`Published on ${new Date(it.snippet.publishedAt).toLocaleDateString()}`
        })).filter(v=>v.id && v.thumbnailUrl);
        const details=await fetchVideoDetails(items.map(i=>i.id));
        items=items.filter(v=>isEducational(v,details[v.id]));
        if(!items.length && !append && !query.toLowerCase().includes('education')){
          return searchYouTube(query+' education',false);
        }
        if(!append) videoGrid.innerHTML='';
        if(!items.length) applyFallback(`Educational results for "${query}"`);
        else {
          const frag=document.createDocumentFragment();
            items.forEach(v=>frag.appendChild(createVideoCard(v)));
            videoGrid.appendChild(frag);
        }
        // suggestions
        items.forEach(v=>v.title.split(/\s+/).forEach(w=>{
          if(w.length>3 && /^[a-z0-9]+$/i.test(w)) suggestionKeywords.push(w);
        }));
        suggestionKeywords=[...new Set(suggestionKeywords)];
        setupLoadMoreButton();
      }catch(e){
        console.error(e);
        if(!append){
          videoGrid.innerHTML='';
          applyFallback(`Educational results for "${query}"`);
        }
        setupLoadMoreButton(true);
      }
    }

    function setupLoadMoreButton(disable=false){
      let btn=document.getElementById('loadMoreBtn');
      if(!nextPageToken){ if(btn) btn.remove(); return; }
      if(!btn){
        btn=document.createElement('button');
        btn.id='loadMoreBtn';
        btn.textContent='Load More';
        btn.style.cssText='grid-column:1/-1;margin:12px auto 32px;padding:10px 24px;border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:24px;cursor:pointer;';
        btn.onclick=()=>{
          if(isLoadingMore) return;
          isLoadingMore=true;
          btn.textContent='Loading...';
          searchYouTube(currentSearchQuery,true).then(()=>{
            isLoadingMore=false;
            btn.textContent='Load More';
            if(!nextPageToken) btn.remove();
          });
        };
        videoGrid.appendChild(btn);
      }
      btn.disabled=disable;
    }

    // Suggestions
    function renderSuggestions(list){
      suggest.innerHTML='';
      if(!list.length){ suggest.classList.remove('open'); return; }
      list.slice(0,10).forEach(t=>{
        const row=document.createElement('div');
        row.className='s-item';
        row.innerHTML=`<span class="icon" style="opacity:.6;"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L19.49 20l1.01-1.01-5-4.99z"/></svg></span><span class="s-text">${t}</span>`;
        row.onmousedown=()=>{ input.value=t; searchYouTube(t); suggest.classList.remove('open'); };
        suggest.appendChild(row);
      });
      suggest.classList.add('open');
    }
    input.addEventListener('input',()=>{
      clearBtn.hidden = !input.value;
      const q=input.value.toLowerCase();
      if(q.length>1){
        const f=suggestionKeywords.filter(k=>k.toLowerCase().includes(q));
        renderSuggestions(f);
      }else renderSuggestions([]);
    });
    input.addEventListener('blur',()=>setTimeout(()=>suggest.classList.remove('open'),150));
    clearBtn.onclick=()=>{ input.value=''; clearBtn.hidden=true; suggest.classList.remove('open'); };

    // Search submit
    searchForm.addEventListener('submit',e=>{
      e.preventDefault();
      const q=input.value.trim();
      if(q) searchYouTube(q);
    });

    // Voice (unchanged core logic)
    // ...existing voice recognition block unchanged...

    // Video player (unchanged)
    // ...existing openVideoPlayer / closeVideoPlayer code...

    // Upload logic (unchanged)
    // ...existing upload code...

    // Navigation
    function setActive(selector){
      document.querySelectorAll('.navbar a').forEach(a=>a.classList.remove('active'));
      const link=document.querySelector(selector);
      if(link) link.classList.add('active');
    }
    function showHomePage(){
      setActive('a[onclick="showHomePage()"]');
      searchResultsContent.style.display='none';
      homePageContent.style.display='block';
    }
    function showSearchPage(){
      setActive('a[onclick="showSearchPage()"]');
      if(input.value.trim()) searchYouTube(input.value.trim());
      else {
        homePageContent.style.display='none';
        searchResultsContent.style.display='block';
        mainTitle.textContent='Enter a search term';
        videoGrid.innerHTML='<p style="grid-column:1/-1;text-align:center;font-size:18px;">Start typing to search...</p>';
      }
      input.focus();
    }
    async function showAllVideos(){
      setActive('a[onclick="showAllVideos()"]');
      homePageContent.style.display='none';
      searchResultsContent.style.display='block';
      mainTitle.textContent='All Community Videos';
      videoGrid.innerHTML='<p style="grid-column:1/-1;text-align:center;">Loading...</p>';
      try{
        const r=await fetch(`${window.location.origin}/api/videos`);
        if(!r.ok) throw new Error('Failed to fetch');
        const vids=await r.json();
        if(!vids.length){
          videoGrid.innerHTML='<p style="grid-column:1/-1;text-align:center;">No videos yet.</p>';
          return;
        }
        const mapped=vids.map(v=>({
          type:'video',
          id:v.id,
          title:v.title,
          channel:v.channel||'Community',
          thumbnailUrl:v.thumbnailUrl||'https://via.placeholder.com/320x180/222/fff?text=Video',
          uploaded:new Date(v.uploadedAt||Date.now()).toLocaleDateString()
        }));
        renderVideoGrid(mapped,videoGrid,'All Community Videos');
      }catch(e){
        videoGrid.innerHTML='<p style="grid-column:1/-1;text-align:center;color:#f66;">Error loading videos.</p>';
      }
    }
    async function showMyVideos(){
      setActive('a[onclick="showMyVideos()"]');
      homePageContent.style.display='none';
      searchResultsContent.style.display='block';
      mainTitle.textContent='My Uploaded Videos';
      videoGrid.innerHTML='<p style="grid-column:1/-1;text-align:center;">Loading...</p>';
      try{
        const r=await fetch(`${window.location.origin}/api/my-videos`);
        if(!r.ok) throw new Error('Failed to fetch');
        const vids=await r.json();
        if(!vids.length){
          videoGrid.innerHTML='<p style="grid-column:1/-1;text-align:center;">No uploads yet.</p>';
          return;
        }
        const frag=document.createDocumentFragment();
        vids.forEach(v=>{
          const card=document.createElement('div');
          card.className='video-card';
          card.onclick=()=>playUploadedVideo(v.publicUrl,v.title,v);
          card.innerHTML=`
            <div class="thumbnail-container">
              <img src="${v.thumbnailUrl||'https://via.placeholder.com/320x180/222/fff?text=Video'}" class="thumbnail" onerror="this.onerror=null;this.src='https://via.placeholder.com/320x180/222/fff?text=Video';">
            </div>
            <div class="video-info">
              <h3 class="video-title">${v.title}</h3>
              <p class="video-meta">${v.channel||'Me'}</p>
              <p class="video-meta">${new Date(v.uploadedAt||Date.now()).toLocaleDateString()}</p>
            </div>`;
          frag.appendChild(card);
        });
        videoGrid.innerHTML='';
        videoGrid.appendChild(frag);
      }catch(e){
        videoGrid.innerHTML='<p style="grid-column:1/-1;text-align:center;color:#f66;">Error loading uploads.</p>';
      }
    }

    function playUploadedVideo(url,title,data){
      openVideoPlayer({type:'video',id:'',title,channel:data?.channel||'Upload',thumbnailUrl:'',uploaded:''});
      // Replace iframe with native video element
      const iframe=document.getElementById('videoPlayer');
      iframe.style.display='none';
      let custom=document.getElementById('customVideoPlayer');
      if(!custom){
        custom=document.createElement('video');
        custom.id='customVideoPlayer';
        custom.controls=true;
        custom.style.width='100%';
        custom.style.borderRadius='8px';
        iframe.parentNode.insertBefore(custom,iframe);
      }
      custom.src=url;
      custom.style.display='block';
    }

    // Initialization
    window.addEventListener('DOMContentLoaded',()=>{
      showHomePage();
    });
  </script>
</body>
</html>
